<!DOCTYPE html>
<html lang = 'ru'>
<head>
	<meta name = 'viewport' content = 'width = device-width, initial-scale = 1, maximum-scale = 1, minimum-scale = 1, user-scalable = no, minimal-ui, shrink-to-fit=no'>
	<meta charset = 'UTF-8'>
	<meta name = 'theme-color' content = '#222831'>
	<meta name = 'full-screen' content = 'yes'>
	<meta http-equiv = 'X-UA-Compatible' content = 'ie=edge'>
	<link rel = 'stylesheet' href = '/styles/bootstrap.min.css'>
	<link rel = 'stylesheet' href = '/styles/style.css'>
	<link rel = 'stylesheet' href = '/styles/noty.css'>

	<link rel = 'icon' href = 'styles/img/favicon.png' type = 'image/png'>
 	<link rel = 'shortcut icon' href = 'styles/img/favicon.png' type = 'image/png'>
 	<link rel = 'alternate' href = 'styles/img/favicon.png'>

	<title>Дежурства</title>

	<link rel = 'preload' href = '/styles/fonts/CenturyGothic.ttf' as = 'font' crossorigin>

	<!-- <link rel = 'shortcut icon' href = '/img/favicon.svg'> -->
</head>
<body class = 'bg-second'>

	<div id = 'header' class = 'd-flex justify-content-between flex-md-row align-items-center p-3 px-md-4 bg-main shadow-sm'>
		<button id = 'remove-button'   class = 'header-button'></button>
		<button id = 'calendar-button' class = 'header-button'></button>
		<h4 id = 'header-title'        class = 'mr-md-auto'>Дежурства</h4>
		<button id = 'reload-button'   class = 'header-button'></button>
		<button id = 'add-button'      class = 'header-button'></button>
		<!-- <nav class = 'my-2 my-md-0 mr-md-3'>

		</nav> -->
		<!-- <a class = 'btn btn-outline-primary' href = '/create'>Новая комната</a> -->
	</div>

	<div class = 'container-fluid'>
		<div class = 'main-table hidden'>
			<span class="loader"><span class="loader-inner"></span></span>
			<table class = 'names-table'>
				<tr class = 'student-row'><td class = 'cell student-cell' data-index = '1'>Богорадников<br>Денис</td></tr>
				<tr class = 'student-row'><td class = 'cell student-cell' data-index = '2'>Бувин<br>Алексей</td></tr>
				<tr class = 'student-row'><td class = 'cell student-cell' data-index = '3'>Дрюченко<br>Артём</td></tr>
				<tr class = 'student-row'><td class = 'cell student-cell' data-index = '4'>Заживихин<br>Дмитрий</td></tr>
				<tr class = 'student-row'><td class = 'cell student-cell' data-index = '5'>Кривдин<br>Сергей</td></tr>
				<tr class = 'student-row'><td class = 'cell student-cell' data-index = '6'>Крючкин<br>Данил</td></tr>
				<tr class = 'student-row'><td class = 'cell student-cell' data-index = '7'>Кузнецов<br>Валерий</td></tr>
				<tr class = 'student-row'><td class = 'cell student-cell' data-index = '8'>Маховицкий<br>Владимир</td></tr>
				<tr class = 'student-row'><td class = 'cell student-cell' data-index = '9'>Машнин<br>Владислав</td></tr>
				<tr class = 'student-row'><td class = 'cell student-cell' data-index = '10'>Озеров<br>Роман</td></tr>
				<tr class = 'student-row'><td class = 'cell student-cell' data-index = '11'>Полыновский<br>Дмитрий</td></tr>
				<tr class = 'student-row'><td class = 'cell student-cell' data-index = '12'>Скорятин<br>Игорь</td></tr>
				<tr class = 'student-row'><td class = 'cell student-cell' data-index = '13'>Спицын<br>Денис</td></tr>
				<tr class = 'student-row'><td class = 'cell student-cell' data-index = '14'>Тярин<br>Богдан</td></tr>
				<tr class = 'student-row'><td class = 'cell student-cell' data-index = '15'>Фурсин<br>Владислав</td></tr>
				<tr class = 'student-row'><td class = 'cell student-cell' data-index = '16'>Шевченко<br>Богдан</td></tr>
				<tr class = 'student-row'><td class = 'cell student-cell' data-index = '17'>Шкиперов<br>Дмитрий</td></tr>
				<tr class = 'student-row'><td class = 'cell student-cell' data-index = '18'>Яковлев<br>Сергей</td></tr>
			</table>

			<table class = 'dates-table'></table>
		</div>
	</div>

	<script src = '/socket.io/socket.io.js'></script>
	<script src = '/js/jquery-1.8.3.min.js'></script>

	<script src = '/js/noty.min.js'></script>
	<script src = '/js/sweetalert.min.js'></script>

	<script>
		const socket = io()

		query = (query) => document.querySelector(query)
		queryAll = (query) => document.querySelectorAll(query)
		String.prototype.reverseDate = function(){return this.split('.').reverse().join('.')}

		let database = []

		function getTodayDate(){return `${String(new Date().getFullYear()).padStart(2,0)}-${String(new Date().getMonth()+1).padStart(2,0)}-${String(new Date().getDate()).padStart(2,0)}`}

		let removeButton   = query('#remove-button')
		let calendarButton = query('#calendar-button')
		let reloadButton   = query('#reload-button')
		let addButton      = query('#add-button')

		let namesTable = document.getElementsByClassName('names-table')[0] //query('.names-table')
		let datesTable = document.getElementsByClassName('dates-table')[0] //query('.dates-table')

		const studentsListTemplate = $(`
		<select id = 'students-list-template' class = 'form-select bg-second border-main mb-4'>
			<option value = ''>Выберите студента</option>
			<option value = 'Богорадников Денис'>Богорадников Денис</option>
			<option value = 'Бувин Алексей'>Бувин Алексей</option>
			<option value = 'Дрюченко Артём'>Дрюченко Артём</option>
			<option value = 'Заживихин Дмитрий'>Заживихин Дмитрий</option>
			<option value = 'Кривдин Сергей'>Кривдин Сергей</option>
			<option value = 'Крючкин Данил'>Крючкин Данил</option>
			<option value = 'Кузнецов Валерий'>Кузнецов Валерий</option>
			<option value = 'Маховицкий Владимир'>Маховицкий Владимир</option>
			<option value = 'Машнин Владислав'>Машнин Владислав</option>
			<option value = 'Озеров Роман'>Озеров Роман</option>
			<option value = 'Полыновский Дмитрий'>Полыновский Дмитрий</option>
			<option value = 'Скорятин Игорь'>Скорятин Игорь</option>
			<option value = 'Спицын Денис'>Спицын Денис</option>
			<option value = 'Тярин Богдан'>Тярин Богдан</option>
			<option value = 'Фурсин Владислав'>Фурсин Владислав</option>
			<option value = 'Шевченко Богдан'>Шевченко Богдан</option>
			<option value = 'Шкиперов Дмитрий'>Шкиперов Дмитрий</option>
			<option value = 'Яковлев Сергей'>Яковлев Сергей</option>
		</select>`)[0]

		function toggleRemoveMenu(){
			let content = document.createElement('div')

			let studentList = studentsListTemplate.cloneNode(true)
			content.appendChild(studentList)

			let datesList = studentsListTemplate.cloneNode(false)
			content.appendChild(datesList)

			studentList.oninput = function(){
				for (let student of database){
					if (student.name === this.value){
						if (student.dates.length > 0){
							datesList.innerHTML = `<option value = ''>Выберите дату</option>`
							for (let date of student.dates){
								datesList.innerHTML += `<option value = '${date}'>${date}</option>`
							}
							return 
						}
					}
				}
				datesList.innerHTML = ''
			}

			// id('remove-form-student-selector').oninput = function(){
			// 	id('remove-form-date-selector').innerHTML = '<option value = "">Выберите дату</option>'
			// 	for (i of database){
			// 		if (i.name == this.value){
			// 			id('remove-form-date-selector').innerHTML = '<option value = "">Выберите дату</option>'
			// 			for (j of i.dates) id('remove-form-date-selector').innerHTML += `<option value = '${j}'>${j}</option>`
			// 		}
			// 	}
			// }

			swal({
				title: 'Удалить дежурство',
				content: content,
				button: {
					text: 'Удалить',
					closeModal: false
				}
			}).then((click)=>{
				if (click){
					socket.emit('remove request', {
						student: (content.children[0] || {}).value, 
						date: (content.children[1] || {}).value})
				}
				else {
					removeButton.classList.remove('opened')
				}
			})

			removeButton.classList.add('opened')
		}

		socket.on('remove response', function(data){
			swal({
				icon: (data.success) ? 'success' : 'error',
				title: data.title,
				text: data.text
			}).then(()=>{
				removeButton.classList.remove('opened')
			})
		})

		function toggleAddMenu(){

			let content = document.createElement('div')

			content.appendChild(studentsListTemplate.cloneNode(true))
			content.appendChild(studentsListTemplate.cloneNode(true))

			let dateSelector = document.createElement('input')

			dateSelector.className = 'bg-second border-main'
			dateSelector.type = 'date'
			dateSelector.value = getTodayDate()

			content.appendChild(dateSelector)

			swal({
				title: 'Добавить дежурство',
				content: content,
				button: {
					text: 'Добавить',
					closeModal: false
				}
			}).then((click)=>{
				if (click){
					socket.emit('add request', {
						student1: (content.children[0] || {}).value,
						student2: (content.children[1] || {}).value,
						date: (content.children[2] || {}).value || getTodayDate()
					})
				}
				else {
					addButton.classList.remove('opened')
				}
			})

			addButton.classList.add('opened')
		}

		socket.on('add response', function(data){
			swal({
				icon: (data.success) ? 'success' : 'error',
				title: data.title,
				text: data.text
			}).then(()=>{
				addButton.classList.remove('opened')
			})
		})

		swal()
		setTimeout(function(){
			swal.close()
		})

		function init(){

			removeButton.addEventListener('click', toggleRemoveMenu)
			addButton.addEventListener('click', toggleAddMenu)

			reloadButton.addEventListener('click', () => {
				window.parent.postMessage('','*')
				location.reload()
			})

			// swal.setDefaults({
			// 	closeOnEsc: false
			// })

			Noty.overrideDefaults({
				theme: 'bootstrap-v4',
				layout: 'bottomRight',
				type: 'dark',
				timeout: 3000,
				progressBar: true
			})

			socket.on('get db response', function(data){
				// new Noty({text: 'Загружено'}).show()
				fillTable(data.db)
				$('.loader').fadeOut(500)
				query('.main-table').classList.remove('hidden')
			})

			socket.on('update db', function(data){
				new Noty({text: 'Обновлено'}).show()
				fillTable(data.db)
			})

			socket.emit('get db request')
		}

		datesTable.onmousedown = function(){
			startX = this.scrollLeft + event.pageX
		    startY = this.scrollTop  + event.pageY
		    datesTable.onmousemove = function(){
		    	this.scrollLeft = startX - event.pageX
		        this.scrollTop  = startY - event.pageY
		        namesTable.scrollTop = this.scrollTop
		        return false
		    }
		}

		window.onmouseup = function(){
			datesTable.onmousemove = function(){return}
		}

		datesTable.onscroll = function(){
			namesTable.scrollTop = datesTable.scrollTop
		}

		studentsIndexes = {
			'Богорадников Денис': 1,
			'Бувин Алексей': 2,
			'Дрюченко Артём': 3,
			'Заживихин Дмитрий': 4,
			'Кривдин Сергей': 5,
			'Крючкин Данил': 6,
			'Кузнецов Валерий': 7,
			'Маховицкий Владимир': 8,
			'Машнин Владислав': 9,
			'Озеров Роман': 10,
			'Полыновский Дмитрий': 11,
			'Скорятин Игорь': 12,
			'Спицын Денис': 13,
			'Тярин Богдан': 14,
			'Фурсин Владислав': 15,
			'Шевченко Богдан': 16,
			'Шкиперов Дмитрий': 17,
			'Яковлев Сергей': 18
		}

		nameOfDaysOfWeek = {
			0: 'воскресенье',
			1: 'понедельник',
			2: 'вторник',
			3: 'среда',
			4: 'четверг',
			5: 'пятница',
			6: 'суббота'
		}

		function fillTable(db){
			database = db
			datesTable.innerHTML = `<tr class = 'date-row'></tr>`.repeat(18)

			for (student of database){
				if (student.dates.length == 0){
					query(`.dates-table .date-row:nth-child(${studentsIndexes[student.name]})`).innerHTML += `<td class = 'cell date-cell empty'></td>`
					// tr[nameToNumber[student.name]].innerHTML += `<td class = 'cell empty'></td>`
				}
				else for (date of student.dates){
					query(`.dates-table .date-row:nth-child(${studentsIndexes[student.name]})`).innerHTML += `
						<td class = 'cell date-cell' data-date = '${date}'>
							<div class = 'inner'>
								<div>${date.split('.').slice(0,2).join('.')}</div>
								<small>${nameOfDaysOfWeek[new Date(date.reverseDate()).getDay()]}</small>
							<div>
						</td>`
					// tr[nameToNumber[student.name]].innerHTML += `<td class = 'mark' data-date = '${j}'><div><div>${j.split('.').slice(0,2).join('.')}</div><small>${daysToNumber[new Date(j.reverseDate()).getDay()]}</small></div></td>`
					// if (j == `${new Date().getDate()}.${new Date().getMonth()+1}.${new Date().getFullYear()}`) onDutyToday.push(student.name)
				}
			}
		}

		window.onload = init
	</script>
 	
</body>
</html> 
