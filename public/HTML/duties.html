<!DOCTYPE html>
 <html lang = 'ru-RU'> 

 <head>
 	<meta charset="UTF-8">
 	<meta name="theme-color" content="#47a19d">
 	<meta name = 'viewport' content = 'width = device-width, initial-scale = 1.0, maximum-scale = 1.0, minimum-scale = 1.0, user-scalable = no, minimal-ui'>
 	<link rel = 'icon' href = 'styles/img/favicon.ico' type = 'image/x-icon'>
 	<link rel = 'shortcut icon' href = 'styles/img/favicon.ico' type = 'image/x-icon'>
 	<link rel = 'alternate' href = 'styles/img/favicon.ico'>
 	<title>Дежурства</title>
 	<link rel="stylesheet" type="text/css" href="styles/style.css" />
	<script>database = JSON.parse('<%-JSON.stringify(database) %>')</script>
 </head>

 <body>
 
	<div id = 'add-form' class = 'form'>
		<form action = '/add' method = 'post' onsubmit = 'document.getElementById("add-form-submit-button").style.pointerEvents = "none"'>
			<select name = 'studentName1' class = 'form-selector' required>
				<option value = ''>Выберите первого студента</option>
				<option value = 'Богорадников Денис'>Богорадников Денис</option>
				<option value = 'Бувин Алексей'>Бувин Алексей</option>
				<option value = 'Дрюченко Артём'>Дрюченко Артём</option>
				<option value = 'Заживихин Дмитрий'>Заживихин Дмитрий</option>
				<option value = 'Кривдин Сергей'>Кривдин Сергей</option>
				<option value = 'Крючкин Данил'>Крючкин Данил</option>
				<option value = 'Кузнецов Валерий'>Кузнецов Валерий</option>
				<option value = 'Маховицкий Владимир'>Маховицкий Владимир</option>
				<option value = 'Машнин Владислав'>Машнин Владислав</option>
				<option value = 'Озеров Роман'>Озеров Роман</option>
				<option value = 'Полыновский Дмитрий'>Полыновский Дмитрий</option>
				<option value = 'Скорятин Игорь'>Скорятин Игорь</option>
				<option value = 'Спицын Денис'>Спицын Денис</option>
				<option value = 'Тярин Богдан'>Тярин Богдан</option>
				<option value = 'Фурсин Владислав'>Фурсин Владислав</option>
				<option value = 'Шевченко Богдан'>Шевченко Богдан</option>
				<option value = 'Шкиперов Дмитрий'>Шкиперов Дмитрий</option>
				<option value = 'Яковлев Сергей'>Яковлев Сергей</option>
			</select><br>
			<select name = 'studentName2' class = 'form-selector'>
				<option value = ''>Выберите второго студента</option>
				<option value = 'Богорадников Денис'>Богорадников Денис</option>
				<option value = 'Бувин Алексей'>Бувин Алексей</option>
				<option value = 'Дрюченко Артём'>Дрюченко Артём</option>
				<option value = 'Заживихин Дмитрий'>Заживихин Дмитрий</option>
				<option value = 'Кривдин Сергей'>Кривдин Сергей</option>
				<option value = 'Крючкин Данил'>Крючкин Данил</option>
				<option value = 'Кузнецов Валерий'>Кузнецов Валерий</option>
				<option value = 'Маховицкий Владимир'>Маховицкий Владимир</option>
				<option value = 'Машнин Владислав'>Машнин Владислав</option>
				<option value = 'Озеров Роман'>Озеров Роман</option>
				<option value = 'Полыновский Дмитрий'>Полыновский Дмитрий</option>
				<option value = 'Скорятин Игорь'>Скорятин Игорь</option>
				<option value = 'Спицын Денис'>Спицын Денис</option>
				<option value = 'Тярин Богдан'>Тярин Богдан</option>
				<option value = 'Фурсин Владислав'>Фурсин Владислав</option>
				<option value = 'Шевченко Богдан'>Шевченко Богдан</option>
				<option value = 'Шкиперов Дмитрий'>Шкиперов Дмитрий</option>
				<option value = 'Яковлев Сергей'>Яковлев Сергей</option>
			</select><br>
			<input type = 'date' name = 'date' id = 'form-date' required></input>
			<input type = 'submit' id = 'add-form-submit-button' class = 'submit-button' value = 'Добавить'>
		</form>
	</div>
	
	<div id = 'remove-form' class = 'form'>
		<form action = '/remove' method = 'post' onsubmit = 'document.getElementById("remove-form-submit-button").style.pointerEvents = "none"'>
			<select name = 'studentName' class = 'form-selector' id = 'remove-form-student-selector' required>
				<option value = ''>Выберите студента</option>
				<option value = 'Богорадников Денис'>Богорадников Денис</option>
				<option value = 'Бувин Алексей'>Бувин Алексей</option>
				<option value = 'Дрюченко Артём'>Дрюченко Артём</option>
				<option value = 'Заживихин Дмитрий'>Заживихин Дмитрий</option>
				<option value = 'Кривдин Сергей'>Кривдин Сергей</option>
				<option value = 'Крючкин Данил'>Крючкин Данил</option>
				<option value = 'Кузнецов Валерий'>Кузнецов Валерий</option>
				<option value = 'Маховицкий Владимир'>Маховицкий Владимир</option>
				<option value = 'Машнин Владислав'>Машнин Владислав</option>
				<option value = 'Озеров Роман'>Озеров Роман</option>
				<option value = 'Полыновский Дмитрий'>Полыновский Дмитрий</option>
				<option value = 'Скорятин Игорь'>Скорятин Игорь</option>
				<option value = 'Спицын Денис'>Спицын Денис</option>
				<option value = 'Тярин Богдан'>Тярин Богдан</option>
				<option value = 'Фурсин Владислав'>Фурсин Владислав</option>
				<option value = 'Шевченко Богдан'>Шевченко Богдан</option>
				<option value = 'Шкиперов Дмитрий'>Шкиперов Дмитрий</option>
				<option value = 'Яковлев Сергей'>Яковлев Сергей</option>
			</select><br>
			<select name = 'date' class = 'form-selector' id = 'remove-form-date-selector' required>
				<option value = ''>Выберите дату</option>
			</select><br>
			<input type = 'submit' id = 'remove-form-submit-button' class = 'submit-button' value = 'Удалить'>
		</form>
	</div>
 
	<header id = 'header'>
		<div id = 'header-title'>Дежурства</div>
		<button id = 'remove-button' onclick = 'toggleRemoveDate()'></button>
		<button id = 'add-button'    onclick = 'toggleAddNewDate()'></button>
	</header>

	<div id = 'main-block'>
		

		<div id = 'info-block'></div>

		<div id = 'table-block'>
			<div>
				<div id = 'rating-block'>
					<table id = 'rating-table'>
						<tr></tr><tr></tr><tr></tr><tr></tr><tr></tr><tr></tr><tr></tr><tr></tr><tr></tr><tr></tr><tr></tr><tr></tr><tr></tr><tr></tr><tr></tr><tr></tr><tr></tr><tr></tr>
					</table>

					<table id = 'names-table'>
						<tr><td class = 'student-cell'>Богорадников<br>Денис</td></tr>
						<tr><td class = 'student-cell'>Бувин<br>Алексей</td></tr>
						<tr><td class = 'student-cell'>Дрюченко<br>Артём</td></tr>
						<tr><td class = 'student-cell'>Заживихин<br>Дмитрий</td></tr>
						<tr><td class = 'student-cell'>Кривдин<br>Сергей</td></tr>
						<tr><td class = 'student-cell'>Крючкин<br>Данил</td></tr>
						<tr><td class = 'student-cell'>Кузнецов<br>Валерий</td></tr>
						<tr><td class = 'student-cell'>Маховицкий<br>Владимир</td></tr>
						<tr><td class = 'student-cell'>Машнин<br>Владислав</td></tr>
						<tr><td class = 'student-cell'>Озеров<br>Роман</td></tr>
						<tr><td class = 'student-cell'>Полыновский<br>Дмитрий</td></tr>
						<tr><td class = 'student-cell'>Скорятин<br>Игорь</td></tr>
						<tr><td class = 'student-cell'>Спицын<br>Денис</td></tr>
						<tr><td class = 'student-cell'>Тярин<br>Богдан</td></tr>
						<tr><td class = 'student-cell'>Фурсин<br>Владислав</td></tr>
						<tr><td class = 'student-cell'>Шевченко<br>Богдан</td></tr>
						<tr><td class = 'student-cell'>Шкиперов<br>Дмитрий</td></tr>
						<tr><td class = 'student-cell'>Яковлев<br>Сергей</td></tr>
						<tr><td class = 'student-cell' style = 'border-color: #0000'></td></tr>
					</table>
				</div>
			</div>
		</div>

		<div id = 'open-fullscreen-block'>
			<div id = 'open-fullscreen' onclick = 'toggleAddNewDate()'>+</div>
			<div id = 'open-fullscreen' onclick = 'toggleRemoveDate()'>-</div>
		</div>

	</div>

	<script>
		
		function id(id){return document.getElementById(id)}
		
		function toggleAddNewDate(){
			if (id('add-form').style.transform == 'scale(1)'){
				id('add-form').style.transform =  'scale(0)'
				id('add-button').classList.remove('opened')

				id('remove-form').style.transform =  'scale(0)'
				id('remove-button').classList.remove('opened')
				window.onclick = null
			}
			else {
				id('add-form').style.transform =  'scale(1)'
				id('add-button').classList.add('opened')
				
				id('remove-form').style.transform =  'scale(0)'
				id('remove-button').classList.remove('opened')
				window.onclick = null
				setTimeout(function(){
					window.onclick = function(e){
						if (!id('add-form').contains(event.target)) {
							id('add-form').style.transform =  'scale(0)'
							id('add-button').classList.remove('opened')

							id('remove-form').style.transform =  'scale(0)'
							id('remove-button').classList.remove('opened')
							window.onclick = null
						}
					}
				})
			}
		}
		
		function toggleRemoveDate(){
			if (id('remove-form').style.transform == 'scale(1)'){
				id('remove-form').style.transform =  'scale(0)'
				id('remove-button').classList.remove('opened')
				
				id('add-form').style.transform =  'scale(0)'
				id('add-button').classList.remove('opened')
				window.onclick = null
			}
			else {
				id('remove-form').style.transform =  'scale(1)'
				id('remove-button').classList.add('opened')
				
				id('add-form').style.transform =  'scale(0)'
				id('add-button').classList.remove('opened')
				window.onclick = null
				setTimeout(function(){
					window.onclick = function(e){
						if (!id('remove-form').contains(event.target)) {
							id('remove-form').style.transform =  'scale(0)'
							id('remove-button').classList.remove('opened')
							
							id('add-form').style.transform =  'scale(0)'
							id('add-button').classList.remove('opened')
							window.onclick = null
						}
					}
				})
			}
		}
		
		id('remove-form-student-selector').oninput = function(){
			id('remove-form-date-selector').innerHTML = '<option value = "">Выберите дату</option>'
			for (i of database){
				if (i.name == this.value){
					id('remove-form-date-selector').innerHTML = '<option value = "">Выберите дату</option>'
					for (j of i.dates) id('remove-form-date-selector').innerHTML += `<option value = '${j}'>${j}</option>`
				}
			}
		}

		ratingTable = id('rating-table')
		ratingTable.onmousedown = function(){
			startX = this.scrollLeft + event.pageX
		    startY = this.scrollTop  + event.pageY
		    ratingTable.onmousemove = function(){
		    	this.scrollLeft = startX - event.pageX
		        this.scrollTop  = startY - event.pageY
		        id('names-table').scrollTop = this.scrollTop
		        return false
		    }
		}
		window.onmouseup = function(){
			ratingTable.onmousemove = function(){return}
		}

		ratingTable.onscroll = function(){
			id('names-table').scrollTop = ratingTable.scrollTop
		}

		nameToNumber = {
			'Богорадников Денис': 0,
			'Бувин Алексей': 1,
			'Дрюченко Артём': 2,
			'Заживихин Дмитрий': 3,
			'Кривдин Сергей': 4,
			'Крючкин Данил': 5,
			'Кузнецов Валерий': 6,
			'Маховицкий Владимир': 7,
			'Машнин Владислав': 8,
			'Озеров Роман': 9,
			'Полыновский Дмитрий': 10,
			'Скорятин Игорь': 11,
			'Спицын Денис': 12,
			'Тярин Богдан': 13,
			'Фурсин Владислав': 14,
			'Шевченко Богдан': 15,
			'Шкиперов Дмитрий': 16,
			'Яковлев Сергей': 17
		}
		
		daysToNumber = {
			0: 'воскресенье',
			1: 'понедельник',
			2: 'вторник',
			3: 'среда',
			4: 'четверг',
			5: 'пятница',
			6: 'суббота'
		}

		monthToNumber = {
			'Сентябрь': '0',
			'Октябрь' : '1',
			'Ноябрь'  : '2',
			'Декабрь' : '3',
			'Январь'  : '4',
			'Февраль' : '5',
			'Март'    : '6',
			'Апрель'  : '7',
			'Май'     : '8'
		}
		
		tr = document.getElementsByTagName('tr')
		
		function fillTable(){
			console.log('new')
			id('rating-table').innerHTML = '<tr></tr>'.repeat(18)
			onDutyToday = []
			for (i of database){
				if (i.dates.length == 0){
					tr[nameToNumber[i.name]].innerHTML += "<td class = 'mark blank'></td>"
				}
				else for (j of i.dates){
					tr[nameToNumber[i.name]].innerHTML += `<td class = 'mark'><div><div>${j.split('.').slice(0,2).join('.')}</div><small>${daysToNumber[new Date(j.split('.').reverse().join('.')).getDay()]}</small></div></td>`
					if (j == `${new Date().getDate()}.${new Date().getMonth()+1}.${new Date().getFullYear()}`) onDutyToday.push(i.name)
				}
			}
			
			// Подсчёт прошедних дней (криво)
			let td = document.querySelectorAll('.mark:not(.blank)')
			for (i of td) {
				i.onmousedown = i.ontouchstart = function(){
					this.innerHTML = `<div><div>${~~((new Date() - new Date(this.children[0].children[0].innerHTML.split('.').reverse().join('.') + '.2020'))/86400000)}</div><small>Дней назад</small></div>`
					console.log('тык')
				}
				i.onmouseup = i.ontouchend = fillTable
			}
			
			if (onDutyToday.length != 0) id('info-block').innerHTML = `Сегодня ${(onDutyToday.length > 1) ? 'дежурят' : 'дежурит'}: ${onDutyToday.join(', ')}`
			else {
				lastDate = 0
				for (i of database){
					for (j of i.dates){
						if (new Date(j.split('.').reverse().join('.')) > lastDate) lastDate = new Date(j.split('.').reverse().join('.'))
					}
				}
				if (lastDate){
					lastDate = `${lastDate.getDate()}.${lastDate.getMonth()+1}.${lastDate.getFullYear()}`
					lastDuty = []
					for (i of database){
						for (j of i.dates){
							if (j == lastDate) lastDuty.push(i.name)
						}
					}
					if (new Date() < new Date(lastDate.split('.').reverse().join('.')))
						id('info-block').innerHTML = `${(lastDuty.length > 1) ? 'Следующие дежурные' : 'Следующий дежурный'}: ${lastDuty.join(', ')}`
					else 
						id('info-block').innerHTML = `Последний раз ${(lastDuty.length > 1) ? 'дежурили' : 'дежурил'}: ${lastDuty.join(', ')}`
				}
			}
		}
		
		window.onload = function(){
			fillTable()
			id('form-date').value = `${new Date().getFullYear()}-${new Date().getMonth()+1}-${new Date().getDate()}`
			setInterval(fillTable, 60000)
			/*setTimeout(function(){
				id('header').style.transform = 'none'
			}, 850)*/
		}

	</script>

 </body>

 </html> 
